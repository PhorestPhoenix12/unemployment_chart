<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>US Unemployment Rate — Hover Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f1214; --card:#14191b; --text:#e7ecec; --muted:#98a2a6; --accent:#0a3f36
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif}
    .container{max-width:1100px;margin-inline:auto;padding:20px}
    .site-header{display:flex;justify-content:space-between;align-items:baseline;gap:1rem;margin-bottom:12px}
    .badge{background:#1a4139;border:1px solid #205045;border-radius:999px;padding:.25rem .6rem}
    .muted{color:var(--muted)}
    .card{background:var(--card);border:1px solid #1e2528;border-radius:14px;overflow:hidden;margin:14px 0}
    .card-head{padding:14px 16px;border-bottom:1px solid #1c2326}
    .map-card svg{display:block;width:100%;height:auto;background:#101416}
    /* your choropleth classes from update_page.py */
    .state path{stroke:#FFFFFF;stroke-width:1;transition:fill .2s ease, stroke .2s ease}
    .state path:hover{stroke:var(--accent);stroke-width:1.5}
    .c0{fill:#e8ecea}.c1{fill:#d6efe3}.c2{fill:#bde4d6}.c3{fill:#9fd6c5}.c4{fill:#7cc5b1}.c5{fill:#55b29a}

    /* timeline slider */
    .timeline-card { margin-top: 10px; }
    .timeline{display:flex;align-items:center;gap:.75rem;padding:.9rem 1rem}
    .timeline input[type="range"]{flex:1}
    .timeline-meta{padding:0 1rem 1rem;color:var(--muted)}
  </style>
</head>
<body>
  <header class="site-header container">
    <h1>US Unemployment Rate</h1>
    <div class="meta">
      <span id="seasonality" class="badge">Seasonally Adjusted</span>
      <span id="refreshed" class="muted">Refreshed: 2025-08-16 17:49 UTC</span>
    </div>
  </header>

  <main class="container">
    <section class="card map-card">
      <div class="card-head">
        <h2>Hover a state to see the latest rate</h2>
      </div>

      <!-- ========== MAP_SVG_START ========== -->
      <!-- Keep your existing SVG exactly as-is between these markers. -->
      <!-- Your SVG must have <g class="state"> with each state as a <path> that includes a two-letter class (al, ak, ...). -->
      <!-- PASTE YOUR SVG HERE -->
      <!-- =========== MAP_SVG_END =========== -->
    </section>

    <!-- Time slider (“mini-FRED” scrubber) -->
    <section class="card timeline-card">
      <div class="card-head">
        <h2>Unemployment over time</h2>
      </div>

      <div class="timeline">
        <span id="tlabel-start" class="muted">—</span>
        <input id="time-slider" type="range" min="0" value="0" step="1" />
        <span id="tlabel-end" class="muted">—</span>
      </div>
      <div class="timeline-meta">
        <span>Showing: <strong id="tlabel-current">—</strong></span>
      </div>
    </section>
  </main>

  <script>
  (async function () {
    // Bucket thresholds -> your existing classes
    function bucket(rate) {
      if (rate == null || isNaN(rate)) return "c0";
      if (rate < 3.0) return "c1";
      if (rate < 3.5) return "c2";
      if (rate < 4.0) return "c3";
      if (rate < 4.5) return "c4";
      return "c5";
    }

    // Collect state paths from your SVG
    const stateNodes = Array.from(document.querySelectorAll('svg .state path'));
    const classToNode = new Map();
    stateNodes.forEach(p => {
      const cls = (p.getAttribute('class') || '').split(/\s+/).find(c => /^[a-z]{2}$/.test(c));
      if (cls) classToNode.set(cls.toUpperCase(), p);
    });

    // UI refs
    const slider = document.getElementById('time-slider');
    const lblStart = document.getElementById('tlabel-start');
    const lblEnd   = document.getElementById('tlabel-end');
    const lblCur   = document.getElementById('tlabel-current');
    const refreshedEl = document.getElementById('refreshed');

    // Load history (same folder as this HTML)
    // Supported shapes:
    // { seasonal:"SA", frames:[{date:"YYYY-MM", rates:{ "AL":3.2, ...}}, ...] }
    // or
    // { seasonal:"SA", dates:["YYYY-MM", ...], states:{ "AL":[3.2,...], ... } }
    let hist;
    try {
      hist = await fetch('unemployment_history.json', { cache: 'no-store' }).then(r => r.json());
    } catch (e) {
      console.error('Failed to load unemployment_history.json', e);
      return;
    }

    let dates = [], frames = [];
    if (Array.isArray(hist?.frames)) {
      frames = hist.frames;
      dates = frames.map(f => f.date);
    } else if (Array.isArray(hist?.dates) && hist?.states) {
      dates = hist.dates;
      frames = dates.map((d, i) => ({
        date: d,
        rates: Object.fromEntries(Object.entries(hist.states).map(([st, arr]) => [st, arr[i]]))
      }));
    } else {
      console.error('Unexpected history JSON shape:', hist);
      return;
    }

    // Initialize slider and labels
    slider.max = String(frames.length - 1);
    slider.value = String(frames.length - 1); // start at latest
    lblStart.textContent = dates[0];
    lblEnd.textContent = dates[dates.length - 1];

    function update(idx) {
      idx = Math.max(0, Math.min(frames.length - 1, idx|0));
      const { date, rates } = frames[idx];
      lblCur.textContent = date;
      if (refreshedEl) refreshedEl.textContent = "Showing: " + date;

      // Update each state path
      for (const [st, node] of classToNode.entries()) {
        const rate = rates[st];
        if (!node) continue;

        node.classList.remove('c0','c1','c2','c3','c4','c5');
        node.classList.add(bucket(rate));

        // Update <title> text
        const titleEl = node.querySelector('title') || document.createElementNS('http://www.w3.org/2000/svg','title');
        const curr = titleEl.textContent || '';
        const name = (curr.split('—')[0] || st).trim();
        titleEl.textContent = `${name} — ${rate != null ? rate.toFixed(1) : '–'}%`;
        if (!titleEl.parentNode) node.appendChild(titleEl);

        // Keep data-rate handy
        if (rate != null) node.setAttribute('data-rate', rate.toFixed(1));
      }
    }

    // First paint & interactions
    update(+slider.value);
    slider.addEventListener('input', () => update(+slider.value));
  })();
  </script>
</body>
</html>
